@model Video_Rental_Shop.ViewModels.NewRentalViewModel

@{
    ViewBag.Title = "New Rental";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>New Rental for @Model.Customer.Name @Model.Customer.Surname</h2>

<div id="buttons">
    <button id="js-moviesButton" class="btn btn-primary">Show Movies</button>
    <button id="js-gamesButton" class="btn btn-primary">Show Video Games</button>
</div>

<table id="movies" class="table table-bordered table-hover">
    <thead>
        <tr style="display:none">
            <th></th>
        </tr>
        <tr>
            <th colspan="2" class="text-center" style="width:5%">Options</th>
            <th class="text-center" style="width:5%">#</th>
            <th>Movie</th>
            <th>Genre</th>
            <th>Release Date</th>
            <th>Number Available</th>
        </tr>
    </thead>
    <tbody>

        @{
            int counter = 1;
        }

        @for (int i = 0; i < Model.Movies.Count(); i++)
        {
            if (Model.Movies.ElementAt(i).NumberAvailable > 0)
            {
                <tr>
                    @if (Model.Customer.Balance >= Model.Movies.ElementAt(i).Price)
                    {
                        <td><button data-customer-id="@Model.Customer.Id" data-movie-id="@Model.Movies.ElementAt(i).Id" data-product-type="Movie" class="btn btn-success btn-xs js-rent-movie-confirm">Rent game</button></td>
                    }
                    else
                    {
                        <td><button class="btn btn-success btn-xs js-rent-movie">Rent movie</button></td>
                    }
                    <td>@Html.ActionLink("Details", "Details", "Movies", new { id = Model.Movies.ElementAt(i).Id }, new { @class = "btn btn-info btn-xs" })</td>
                    <td class="text-center">@(counter++)</td>
                    <td>@Model.Movies.ElementAt(i).Name</td>
                    <td>@Model.Movies.ElementAt(i).MovieGenre.Name</td>
                    <td>@Model.Movies.ElementAt(i).ReleaseDate.Value.ToShortDateString()</td>
                    <td>@Model.Movies.ElementAt(i).NumberAvailable</td>
                </tr>
            }
        }
    </tbody>
</table>

<table id="games" class="table table-bordered table-hover">
    <thead>
        <tr style="display:none">
            <th></th>
        </tr>
        <tr>
            <th colspan="2" class="text-center" style="width:5%">Options</th>
            <th class="text-center" style="width:5%">#</th>
            <th>Movie</th>
            <th>Genre</th>
            <th>Platform</th>
            <th>Release Date</th>
            <th>Number Available</th>
        </tr>
    </thead>
    <tbody>
        @{
            counter = 1;
        }

        @for (int i = 0; i < Model.Games.Count(); i++)
        {
            if (Model.Games.ElementAt(i).NumberAvailable > 0)
            {
                <tr>

                    @if (Model.Customer.Balance >= Model.Games.ElementAt(i).Price)
                    {
                        <td><button data-customer-id="@Model.Customer.Id" data-game-id="@Model.Games.ElementAt(i).Id" data-product-type="Game" class="btn btn-success btn-xs js-rent-game-confirm">Rent game</button></td>
                    }
                    else
                    {
                        <td><button class="btn btn-success btn-xs js-rent-game">Rent game</button></td>
                    }
                    <td>@Html.ActionLink("Details", "Details", "Games", new { id = Model.Games.ElementAt(i).Id }, new { @class = "btn btn-info btn-xs" })</td>
                    <td class="text-center">@(counter++)</td>
                    <td>@Model.Games.ElementAt(i).Name</td>
                    <td>@Model.Games.ElementAt(i).GameGenre.Name</td>
                    <td>@Model.Games.ElementAt(i).GamePlatform.Name</td>
                    <td>@Model.Games.ElementAt(i).ReleaseDate.Value.ToShortDateString()</td>
                    <td>@Model.Games.ElementAt(i).NumberAvailable</td>
                </tr>
            }
        }
    </tbody>
</table>

@section scripts
{
    <script>
        $(document).ready(function () {

            $("#movies").DataTable();
            $('#games').dataTable();
            $("#games").hide();
            $("#games_wrapper").hide()

            $('#js-moviesButton').click(function () {
                $("#movies").show()
                $("#games").hide()
                $("#movies_wrapper").show()
                $("#games_wrapper").hide()
            });

            $('#js-gamesButton').click(function () {
                $("#games").show()
                $("#movies").hide()
                $("#games_wrapper").show()
                $("#movies_wrapper").hide()
            });
        });

        $("#movies").on("click", ".js-rent-movie", function () {
            toastr.error("Insufficient founds");
        });

        $("#movies").on("click", ".js-rent-movie-confirm", function () {
            var button = $(this);

            bootbox.confirm("Are you sure you want to rent this game?", function (result) {
                if (result) {
                    $.ajax({
                        url: "/Rentals/Save/" + button.attr("data-customer-id") + "/" + button.attr("data-movie-id") + "/" + button.attr("data-product-type"),
                        dataType: 'json',
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'Redirect')
                                window.location = response.url;
                        }
                    });
                }
            });
        });

        $("#games").on("click", ".js-rent-game", function () {
            toastr.error("Insufficient founds");
        });

        $("#games").on("click", ".js-rent-game-confirm", function () {
            var button = $(this);

            bootbox.confirm("Are you sure you want to rent this game?", function (result) {
                if (result) {
                    $.ajax({
                        url: "/Rentals/Save/" + button.attr("data-customer-id") + "/" + button.attr("data-game-id") + "/" + button.attr("data-product-type"),
                        dataType: 'json',
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'Redirect')
                                window.location = response.url;
                        }
                    });
                }
            });
        });
    </script>
}